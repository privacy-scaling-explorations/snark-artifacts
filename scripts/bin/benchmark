#!/bin/bash

dl() {
  local cdn="$1"
  local artifact="$2"
  local version=${cdn/*github.com*/1.0.0}
  version=${version//*/latest}

  local url="$cdn/@zk-kit/poseidon-artifacts@$version/$artifact"
  curl -s -o /dev/null "$url"
}

dl_all() {
  local cdn="$1"
  # poseidon is the package that has the most artifacts
  # so using it for testing
  # deliberately download concurrently as this is what is taking so long
  # and causing issues in zk-kit ci atm
  start=$(date +%s)
  for artifact in poseidon-{1..16}.{wasm,zkey}; do
    dl "$cdn" "$artifact"
  done
  end=$(date +%s)
  echo "$cdn,$((end - start))"
}

main() {
  local log
  log=$(mktemp)

  for cdn in "https://cdn.jsdelivr.net/npm" "https://unpkg.com"; do
    for _ in {1..10}; do
      dl_all "$cdn" | tee -a "$log" &
    done
  done

  wait
  echo "done, results are in $log:"
}

main
