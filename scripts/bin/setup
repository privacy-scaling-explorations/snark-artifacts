#!/bin/bash
set -eou pipefail
shopt -s globstar

fetch_and_source_lib() {
  local lib_base_path="https://raw.githubusercontent.com/privacy-scaling-explorations/snark-artifacts/main/scripts/lib"
  local lib_name="$1"
  local libs_path
  libs_path="$(mktemp -d)"
  local lib_path="$libs_path/$lib_name"

  curl -sSL "$lib_base_path/$lib_name" -o "$lib_path"

  # shellcheck source=/dev/null
  source "$lib_path"
}

fetch_and_source_libs() {
  for lib in "$@"; do
    fetch_and_source_lib "$lib"
  done
}

main() {
  fetch_and_source_libs {clone,direction,find-repo,print,prompts,sparse-checkout,consts/{colors,remote-url}}.bash

  local action
  local repo_dir
  repo_dir=$(find_repo)

  if [[ $repo_dir ]]; then
    print "Repository already cloned at $(brown "$repo_dir")"
  else
    repo_dir=$(clone_repository)
    cd "$repo_dir"
    maybe_init_sparse_checkout "$repo_dir"
  fi

  cd "$repo_dir"
  action=$(read_action)
  edit_sparse_checkout "$action" "$(read_package action)"
}

exec 3>/dev/tty
main
exec 3>&-
