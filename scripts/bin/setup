#!/bin/bash
set -eou pipefail
shopt -s globstar

lib_path="$(cd "$(dirname "${BASH_SOURCE[0]}")" && cd ../lib && pwd)"
# shellcheck source=/dev/null
for lib in "$lib_path"/**/*.bash; do source "$lib"; done

main() {
  local action
  local repo_dir
  repo_dir=$(find_repo)

  if [[ $repo_dir ]]; then
    print "Repository already cloned at $(brown "$repo_dir")"
  else
    repo_dir=$(clone_repository)
    cd "$repo_dir"
    maybe_init_sparse_checkout "$repo_dir"
  fi

  cd "$repo_dir"
  action=$(read_action)
  edit_sparse_checkout "$action" "$(read_package action)"
}

exec 3>/dev/tty
main
exec 3>&-
